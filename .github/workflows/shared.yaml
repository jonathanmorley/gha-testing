on:
  workflow_call:
    inputs:
      runners:
        required: true
        type: string
      build:
        required: false
        type: string
      lint:
        required: false
        type: string
      unit-test:
        required: false
        type: string
      integration-test:
        required: false
        type: string
jobs:
  plan:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - name: Create manifest
        id: plan
        uses: actions/github-script@v7
        with:
          script: |
            const inputs = JSON.parse(process.env.INPUTS);
            const runners = JSON.parse(inputs.runners);
            const build = JSON.parse(inputs.build);
            const lint = JSON.parse(inputs.lint);
            const unitTest = JSON.parse(inputs['unit-test']);
            const integrationTest = JSON.parse(inputs['integration-test']);

            console.log(runners, build, lint, unitTest, integrationTest);
            console.log(process.env);
        env:
          INPUTS: ${{ toJson(inputs) }}
    outputs:
      plan: ${{ steps.plan.outputs.result }}
  shards:
    needs: [plan]
    strategy:
      matrix: ${{ fromJson(needs.plan.outputs.plan).includes }}
    runs-on: ${{ matrix.includes.runner }}
    steps:
      - uses: actions/checkout@v2
      - uses: jdx/mise-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      - run: pnpm install
      - run: pnpm nx run-many -t ${{ join(matrix.includes.targets) }}
