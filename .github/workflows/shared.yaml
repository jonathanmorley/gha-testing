on:
  workflow_call:
jobs:
  plan:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - name: Create manifest
        id: plan
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const matrix = JSON.parse(fs.readFileSync('.github/workflows/matrix.json', 'utf8'));
            const includes = matrix.shards.flatMap(shard => shard.runners.map(runner => {
              delete shard.runners;
              return { runner, ...shard };
            }));
            console.log(includes);
            return { matrix: { includes } };
    outputs:
      plan: ${{ steps.plan.outputs.result }}
  fan-out:
    needs: [plan]
    strategy:
      matrix: ${{ fromJson(needs.plan.outputs.plan).matrix }}
    runs-on: ubuntu-latest
    steps:
      - run: echo "Running on ${{ matrix }}"
      - uses: actions/checkout@v2
      - uses: jdx/mise-action@v2
      - run: pnpm install
      - run: pnpm nx run-many -t ${{ join(matrix.targets) }}
